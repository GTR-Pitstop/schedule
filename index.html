<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GTR Shift System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #DD4814;
            --primary-dark: #b83a0f;
            --bg-dark: #0f0f13;
            --card-bg: rgba(30, 30, 35, 0.95);
            --sidebar-bg: #1a1a1a;
            --border-color: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-muted: #a0a0a0;
            --success: #00c853;
            --gtr-blue: #00609C; /* Blue from the image */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050505 0%, #1a0a05 100%);
            margin: 0;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- HEADER --- */
        header {
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 2px solid var(--primary);
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(221, 72, 20, 0.15);
        }

        .brand { display: flex; align-items: center; gap: 15px; }
        .brand img { height: 40px; width: auto; object-fit: contain; }
        .brand-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            display: none;
        }
        @media(min-width: 600px) { .brand-text { display: block; } }

        .mode-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-family: 'Rajdhani', sans-serif;
        }
        .mode-btn:hover { background: var(--primary); color: white; }

        /* --- CONTAINER --- */
        .container {
            width: 95%;
            max-width: 1200px;
            margin-top: 1.5rem;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ADMIN LAYOUT (SIDEBAR + CONTENT) --- */
        .admin-layout {
            display: flex;
            min-height: 80vh;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-item {
            padding: 15px 25px;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.3s;
            border-left: 4px solid transparent;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background: rgba(221, 72, 20, 0.1);
            color: white;
            border-left-color: var(--primary);
        }

        .sidebar-item i { width: 20px; text-align: center; }

        /* CONTENT AREA */
        .admin-content {
            flex-grow: 1;
            padding: 0;
            overflow-y: auto;
            position: relative;
        }

        .admin-tab { display: none; padding: 25px; }
        .admin-tab.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- TOP FILTER BAR (IMAGE STYLE) --- */
        .filter-bar {
            background: linear-gradient(90deg, #007bb5 0%, #005a8d 100%); /* Blue gradient like image */
            padding: 15px 20px;
            border-radius: 50px; /* Rounded pill shape */
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 150px; }
        .filter-group label { color: white; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        
        .filter-input {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
        }
        .filter-input:focus { background: white; color: #333; outline: none; }

        .btn-search {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            height: 38px;
        }
        .btn-search:hover { background: #27ae60; }

        /* --- FORMS --- */
        .form-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        label { color: var(--text-muted); font-size: 0.85rem; display: block; margin-bottom: 5px; text-transform: uppercase; font-weight: 700; }
        input, select { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { background: linear-gradient(90deg, #900 0%, #d00 100%); /* Red Header like image */ color: white; }
        th { padding: 12px; text-align: left; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        td { padding: 12px; border-bottom: 1px solid #333; color: #eee; }
        tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        tr:hover { background: rgba(255,255,255,0.05); }

        .team-badge { background: #333; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #555; }
        .shift-tag { background: rgba(0, 96, 156, 0.3); color: #4facfe; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; border: 1px solid rgba(0, 96, 156, 0.5); }

        /* --- STAFF SECTION (Public) --- */
        .public-search-box {
            background: var(--card-bg);
            border: 1px solid var(--primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #333; color: white; border: 1px solid #555; }
        .btn-export { background: #00609C; color: white; display: inline-block; width: auto; padding: 10px 20px; }

        /* Modal & Mobile */
        .dashboard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .dashboard-card { background: #1a1a1a; width: 90%; max-width: 450px; padding: 2rem; border-radius: 20px; border: 1px solid var(--primary); text-align: center; position: relative; }
        .time-display { font-size: 3rem; font-family: 'Rajdhani', sans-serif; font-weight: 700; color: white; margin: 10px 0; }

        @media(max-width: 768px) {
            .admin-layout { flex-direction: column; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; }
            .sidebar-item { padding: 10px; font-size: 0.9rem; }
            .filter-bar { flex-direction: column; border-radius: 12px; }
            .filter-group { width: 100%; }
            .btn-search { width: 100%; }
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <img src="logoGTR.png" alt="GTR Logo"> 
            <span class="brand-text">SHIFT SYSTEM</span>
        </div>
        <button class="mode-btn" onclick="switchMode()">
            <i class="fas fa-lock"></i> Admin Access
        </button>
    </header>

    <div id="staffSection" class="container">
        <div class="public-search-box">
            <h3 style="margin-top:0; color: var(--primary); font-family:'Rajdhani';">STAFF CHECK-IN</h3>
            <div class="grid-2">
                <div>
                    <label>Select Date</label>
                    <input type="date" id="searchDateInput" onchange="loadPublicStaffList()">
                </div>
                <div>
                    <label>Search Name / Team</label>
                    <input type="text" id="searchStaffInput" placeholder="Type to filter..." onkeyup="filterStaffTable()">
                </div>
            </div>
        </div>

        <div class="form-card" style="padding:0; overflow:hidden;">
            <div style="padding: 15px; background: #222; border-bottom:1px solid #333;">
                <span style="font-weight:bold; color:#fff;">TODAY'S ROSTER</span>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Team</th>
                            <th>Shift</th>
                            <th>Time</th>
                            <th style="text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="publicStaffTableBody"></tbody>
                </table>
            </div>
            <div id="emptyMsg" style="padding: 20px; text-align: center; color: #777;">No schedule found.</div>
        </div>
    </div>

    <div id="adminSection" class="container hidden">
        
        <div class="admin-layout">
            <div class="sidebar">
                <div class="sidebar-item active" onclick="showTab('tab-roster', this)">
                    <i class="fas fa-list-alt"></i> Roster View
                </div>
                <div class="sidebar-item" onclick="showTab('tab-assign', this)">
                    <i class="fas fa-user-plus"></i> Assign Shift
                </div>
                <div class="sidebar-item" onclick="showTab('tab-presets', this)">
                    <i class="fas fa-clock"></i> Shift Presets
                </div>
                <div class="sidebar-item" onclick="showTab('tab-data', this)">
                    <i class="fas fa-database"></i> Staff Data
                </div>
                <div style="margin-top: auto; padding: 20px;">
                    <button onclick="switchMode()" style="background: #333; color: #aaa; width: 100%; border: 1px solid #444; padding: 10px; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Exit Admin
                    </button>
                </div>
            </div>

            <div class="admin-content">
                
                <div id="tab-roster" class="admin-tab active">
                    <h3 style="font-family:'Rajdhani'; margin-top:0; color:white;">SHIFT ROSTER VIEW</h3>
                    
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>From Date</label>
                            <input type="date" id="filterDateFrom" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label>To Date</label>
                            <input type="date" id="filterDateTo" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label>Department / Team</label>
                            <input type="text" id="filterDept" class="filter-input" placeholder="All Departments">
                        </div>
                        <button class="btn-search" onclick="loadAdminTable()"><i class="fas fa-search"></i> SEARCH</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="min-width: 800px;">
                            <thead>
                                <tr>
                                    <th>Staff Name</th>
                                    <th>Department</th>
                                    <th>Date</th>
                                    <th>Shift Name</th>
                                    <th>Time</th>
                                    <th style="text-align: right;">Manage</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-assign" class="admin-tab">
                    <h3 style="font-family:'Rajdhani'; margin-top:0;">ASSIGN STAFF ROSTER</h3>
                    <div class="form-card">
                        <div class="grid-2">
                            <div>
                                <label>Staff Name</label>
                                <input type="text" id="adminName" placeholder="Full Name">
                            </div>
                            <div>
                                <label>Team / Department</label>
                                <input type="text" id="adminTeam" placeholder="e.g. Ramp Team">
                            </div>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div>
                                <label>Date</label>
                                <input type="date" id="adminDate">
                            </div>
                            <div>
                                <label style="color: var(--success);">Select Shift</label>
                                <select id="adminShiftSelect" onchange="previewShiftTime()"></select>
                            </div>
                        </div>
                        <p id="shiftPreview" style="text-align:right; font-size:0.8rem; color:#888;">Time: -</p>
                        <button class="btn btn-primary" onclick="saveRoster()">Confirm Assignment</button>
                    </div>
                </div>

                <div id="tab-presets" class="admin-tab">
                    <h3 style="font-family:'Rajdhani'; margin-top:0;">MANAGE SHIFT TYPES</h3>
                    <div class="form-card">
                        <div class="grid-3">
                            <div><label>Name</label><input type="text" id="regShiftName" placeholder="e.g. Morning"></div>
                            <div><label>Start</label><input type="time" id="regShiftStart"></div>
                            <div><label>End</label><input type="time" id="regShiftEnd"></div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveShiftType()">+ Add Preset</button>
                    </div>
                    <label>Current Presets:</label>
                    <div id="shiftTagsContainer" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <div id="tab-data" class="admin-tab">
                    <h3 style="font-family:'Rajdhani'; margin-top:0;">STAFF DATA CENTER</h3>
                    <div class="form-card">
                        <p style="color:#ccc;">Export staff roster data including Name, ID (Name based), Department and Shifts to CSV/Excel.</p>
                        <button class="btn btn-export" onclick="exportStaffData()">
                            <i class="fas fa-file-download"></i> Download Staff List (.CSV)
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="clockInModal" class="dashboard-overlay hidden">
        <div class="dashboard-card">
            <button onclick="closeModal()" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">&times;</button>
            <h3 id="modalStaffName" style="color: var(--primary); margin: 0;">-</h3>
            <span id="modalShiftName" class="shift-tag" style="margin-bottom: 10px; display:inline-block;">-</span>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                <div style="background: #333; padding: 10px; border-radius: 8px; width: 100px;">
                    <small style="color:#888; display:block;">IN</small>
                    <strong id="modalStart" style="font-size: 1.2rem;">-</strong>
                </div>
                <div style="background: #333; padding: 10px; border-radius: 8px; width: 100px;">
                    <small style="color:#888; display:block;">OUT</small>
                    <strong id="modalEnd" style="font-size: 1.2rem;">-</strong>
                </div>
            </div>
            <div class="time-display" id="liveClock">00:00:00</div>
            <p id="liveDate" style="color: var(--primary); margin-top: -10px;">-</p>
            <div id="statusBadge" style="margin: 10px auto; display: inline-block; padding: 5px 10px; background: #333; border-radius: 4px;">Ready</div>
            <button id="btnIn" class="btn btn-success" onclick="doClockIn()">CLOCK IN</button>
            <button id="btnOut" class="btn btn-danger" onclick="doClockOut()" disabled>CLOCK OUT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, query, where, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUBoGLEI2rbOCQ2tLkCUZ-OIm35QRxiGs",
            authDomain: "gtr-pitstop.firebaseapp.com",
            projectId: "gtr-pitstop",
            storageBucket: "gtr-pitstop.firebasestorage.app",
            messagingSenderId: "661099399124",
            appId: "1:661099399124:web:b6590f033eaa3a0c3e3841",
            measurementId: "G-R210LCD60D"
        };

        let db;
        let allStaffList = [];
        let availableShifts = [];

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            initDates();
        } catch (e) { console.error("Firebase Error", e); }

        function initDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('searchDateInput').value = today;
            document.getElementById('adminDate').value = today;
            
            // For Range filter
            document.getElementById('filterDateFrom').value = today;
            document.getElementById('filterDateTo').value = today;

            loadPublicStaffList();
            loadShiftTypes(); 
        }

        // --- GLOBAL STATE ---
        let currentUserSchedule = null;

        // --- TAB NAVIGATION ---
        window.showTab = function(tabId, element) {
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(tabId).classList.add('active');
            
            // Sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            if(tabId === 'tab-roster') loadAdminTable();
        }

        window.switchMode = function() {
            const staffSec = document.getElementById('staffSection');
            const adminSec = document.getElementById('adminSection');
            
            if (staffSec.classList.contains('hidden')) {
                staffSec.classList.remove('hidden');
                adminSec.classList.add('hidden');
                loadPublicStaffList();
            } else {
                const pass = prompt("Admin Password:");
                if (pass === "12345") {
                    staffSec.classList.add('hidden');
                    adminSec.classList.remove('hidden');
                    loadShiftTypes();
                    loadAdminTable();
                }
            }
        }

        window.closeModal = function() {
            document.getElementById('clockInModal').classList.add('hidden');
            currentUserSchedule = null;
        }

        // --- CLOCK ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('liveClock').innerText = timeStr;
            document.getElementById('liveDate').innerText = now.toDateString();

            if (currentUserSchedule && !document.getElementById('btnOut').disabled) {
                if (timeStr.substring(0,5) >= currentUserSchedule.shiftEnd) {
                    doClockOut(true);
                }
            }
        }
        setInterval(updateClock, 1000);

        // --- EXPORT DATA FUNCTION ---
        window.exportStaffData = async function() {
            if(!db) return;
            // Fetch all roster data (Client side export for simplicity in single file)
            // Note: For large datasets, use a backend function. Here we iterate.
            try {
                const querySnapshot = await getDocs(collection(db, "roster"));
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Name,Department,Date,Shift Name,Start Time,End Time\n"; // Header

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = `${data.name},${data.team},${data.date},${data.shiftName},${data.shiftStart},${data.shiftEnd}`;
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "gtr_staff_roster.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                alert("Export Failed: " + e.message);
            }
        }

        // --- SHIFT LOGIC ---
        window.saveShiftType = async function() {
            const name = document.getElementById('regShiftName').value;
            const start = document.getElementById('regShiftStart').value;
            const end = document.getElementById('regShiftEnd').value;
            if(!name || !start || !end) return alert("Fill all fields");
            try {
                await setDoc(doc(db, "shift_types", name), { label: name, start: start, end: end });
                alert("Shift Added!");
                loadShiftTypes(); 
                document.getElementById('regShiftName').value = "";
            } catch (e) { console.error(e); }
        }

        window.loadShiftTypes = async function() {
            if(!db) return;
            const querySnapshot = await getDocs(collection(db, "shift_types"));
            availableShifts = [];
            const dropdown = document.getElementById('adminShiftSelect');
            const tagsContainer = document.getElementById('shiftTagsContainer');
            dropdown.innerHTML = '<option value="">-- Select Shift --</option>';
            tagsContainer.innerHTML = '';

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                availableShifts.push(data);
                const opt = document.createElement('option');
                opt.value = data.label; 
                opt.text = `${data.label} (${data.start} - ${data.end})`;
                dropdown.appendChild(opt);
                const tag = document.createElement('span');
                tag.className = 'shift-tag';
                tag.style.background = '#333';
                tag.style.marginRight = '5px';
                tag.innerHTML = `${data.label} <i class="fas fa-trash" onclick="deleteShiftType('${doc.id}')" style="cursor:pointer; color:#888; margin-left:5px;"></i>`;
                tagsContainer.appendChild(tag);
            });
        }

        window.deleteShiftType = async function(id) {
            if(confirm("Remove shift?")) {
                await deleteDoc(doc(db, "shift_types", id));
                loadShiftTypes();
            }
        }

        window.previewShiftTime = function() {
            const selectedLabel = document.getElementById('adminShiftSelect').value;
            const preview = document.getElementById('shiftPreview');
            const found = availableShifts.find(s => s.label === selectedLabel);
            preview.innerText = found ? `Time: ${found.start} - ${found.end}` : `Time: -`;
        }

        window.saveRoster = async function() {
            const name = document.getElementById('adminName').value.trim();
            const team = document.getElementById('adminTeam').value.trim();
            const date = document.getElementById('adminDate').value;
            const shiftLabel = document.getElementById('adminShiftSelect').value;

            if (!name || !team || !date || !shiftLabel) return alert("Fill all fields");

            const shiftData = availableShifts.find(s => s.label === shiftLabel);
            if(!shiftData) return alert("Shift Error");

            const docId = `${name.replace(/\s+/g, '_')}_${date}`;

            try {
                await setDoc(doc(db, "roster", docId), { 
                    name: name, team: team, date: date,
                    shiftName: shiftData.label, shiftStart: shiftData.start, shiftEnd: shiftData.end 
                }, { merge: true });
                alert("Saved!");
                document.getElementById('adminName').value = "";
            } catch (e) { alert("Error: " + e.message); }
        }

        // --- ADMIN TABLE (With Range Filter) ---
        window.loadAdminTable = async function() {
            const tbody = document.getElementById('adminTableBody');
            const fromDate = document.getElementById('filterDateFrom').value;
            const toDate = document.getElementById('filterDateTo').value;
            const deptFilter = document.getElementById('filterDept').value.toLowerCase();

            tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

            // Firestore range query (Requires Index usually, so we fetch broadly or simple query then filter in JS for small app)
            // Here we just fetch ALL roster and filter client side for simplicity in a single-file prototype
            // Optimally: query(collection(db, "roster"), where("date", ">=", fromDate), where("date", "<=", toDate))
            
            try {
                const querySnapshot = await getDocs(collection(db, "roster"));
                tbody.innerHTML = "";
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Client Side Filtering
                    if (data.date >= fromDate && data.date <= toDate) {
                        if(deptFilter === "" || data.team.toLowerCase().includes(deptFilter)) {
                            count++;
                            tbody.innerHTML += `
                                <tr>
                                    <td><b>${data.name}</b></td>
                                    <td><span class="team-badge">${data.team}</span></td>
                                    <td>${data.date}</td>
                                    <td><span class="shift-tag">${data.shiftName || 'Custom'}</span></td>
                                    <td>${data.shiftStart} - ${data.shiftEnd}</td>
                                    <td style="text-align: right;">
                                        <button onclick="deleteRoster('${doc.id}')" style="color:#d00; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                        }
                    }
                });

                if(count === 0) tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No records found.</td></tr>";
            } catch (e) { console.error(e); }
        }

        window.deleteRoster = async function(docId) {
            if(confirm("Delete entry?")) {
                await deleteDoc(doc(db, "roster", docId));
                loadAdminTable();
            }
        }

        // --- PUBLIC STAFF ---
        window.loadPublicStaffList = async function() {
            if (!db) return;
            const tbody = document.getElementById('publicStaffTableBody');
            const selectedDate = document.getElementById('searchDateInput').value;
            const emptyMsg = document.getElementById('emptyMsg');
            tbody.innerHTML = "";
            
            const q = query(collection(db, "roster"), where("date", "==", selectedDate));
            const querySnapshot = await getDocs(q);
            
            allStaffList = [];
            querySnapshot.forEach((doc) => allStaffList.push(doc.data()));

            if (allStaffList.length === 0) emptyMsg.style.display = 'block';
            else {
                emptyMsg.style.display = 'none';
                renderTable(allStaffList);
            }
        }

        function renderTable(list) {
            const tbody = document.getElementById('publicStaffTableBody');
            tbody.innerHTML = "";
            list.forEach(staff => {
                const tr = document.createElement('tr');
                tr.onclick = () => openClockModal(staff);
                tr.innerHTML = `
                    <td><b>${staff.name}</b></td>
                    <td><span class="team-badge">${staff.team}</span></td>
                    <td><span class="shift-tag">${staff.shiftName || 'Shift'}</span></td>
                    <td>${staff.shiftStart} - ${staff.shiftEnd}</td>
                    <td style="text-align:right;"><button style="background:none; border:1px solid #555; color:#ccc; border-radius:4px;">SELECT</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.filterStaffTable = function() {
            const txt = document.getElementById('searchStaffInput').value.toLowerCase();
            const filtered = allStaffList.filter(s => s.name.toLowerCase().includes(txt) || s.team.toLowerCase().includes(txt));
            renderTable(filtered);
        }

        function openClockModal(staff) {
            currentUserSchedule = staff;
            document.getElementById('clockInModal').classList.remove('hidden');
            document.getElementById('modalStaffName').innerText = staff.name;
            document.getElementById('modalShiftName').innerText = staff.shiftName || staff.team;
            document.getElementById('modalStart').innerText = staff.shiftStart;
            document.getElementById('modalEnd').innerText = staff.shiftEnd;
            document.getElementById('btnIn').disabled = false;
            document.getElementById('btnOut').disabled = true;
        }

        window.doClockIn = async function() {
            if(!currentUserSchedule) return;
            const btnIn = document.getElementById('btnIn');
            btnIn.disabled = true;
            try {
                await addDoc(collection(db, "attendance"), {
                    name: currentUserSchedule.name, team: currentUserSchedule.team, date: currentUserSchedule.date,
                    shift: currentUserSchedule.shiftName, type: "CLOCK_IN", timestamp: serverTimestamp(), localTime: new Date().toString()
                });
                document.getElementById('clockInModal').classList.add('hidden');
                alert("Clock In Success!");
            } catch (e) { btnIn.disabled = false; }
        }

        window.doClockOut = async function(isAuto = false) {
             if(!currentUserSchedule) return;
             try {
                await addDoc(collection(db, "attendance"), {
                    name: currentUserSchedule.name, type: "CLOCK_OUT", method: isAuto ? "AUTO" : "MANUAL",
                    timestamp: serverTimestamp(), localTime: new Date().toString()
                });
                if(!isAuto) {
                    document.getElementById('clockInModal').classList.add('hidden');
                    alert("Clock Out Success!");
                }
            } catch (e) { console.log(e); }
        }

        window.deleteRoster = deleteRoster;
        window.deleteShiftType = deleteShiftType;
        window.loadShiftTypes = loadShiftTypes;
        window.loadAdminTable = loadAdminTable;
        window.loadPublicStaffList = loadPublicStaffList;
        window.showTab = showTab;
        window.exportStaffData = exportStaffData;

    </script>
</body>
</html>
