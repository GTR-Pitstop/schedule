<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GTR Shift System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #DD4814; /* Vermillion */
            --primary-dark: #b83a0f;
            --bg-dark: #0f0f13; /* Deep dark bg similar to image */
            --card-bg: rgba(30, 30, 35, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-muted: #a0a0a0;
            --success: #00c853;
            --danger: #ff3d00;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050505 0%, #1a0a05 100%);
            margin: 0;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        /* --- HEADER --- */
        header {
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 2px solid var(--primary);
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(221, 72, 20, 0.15);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand img { 
            height: 40px; /* Logo size */
            width: auto;
            object-fit: contain;
        }

        .brand-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            display: none; /* Hide text on mobile if logo exists, optional */
        }
        @media(min-width: 600px) { .brand-text { display: block; } }

        .mode-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 4px; /* Boxy look like image */
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-family: 'Rajdhani', sans-serif;
        }
        .mode-btn:hover { background: var(--primary); color: white; }

        /* --- LAYOUT CONTAINERS --- */
        .container {
            width: 95%;
            max-width: 1000px; /* Wider for table */
            margin-top: 1.5rem;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1. SEARCH SECTION (Top) --- */
        .search-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary); /* Accent */
        }

        .search-label {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 20px;
            display: block;
            font-size: 1.1rem;
        }

        .search-bar-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-bar-wrapper i {
            position: absolute;
            left: 15px;
            color: var(--primary);
        }

        input[type="text"] {
            width: 100%;
            padding: 14px 14px 14px 45px; /* Space for icon */
            background: rgba(0,0,0,0.4);
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: 0.3s;
        }
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(221, 72, 20, 0.2);
            outline: none;
        }

        /* --- 2. TABLE SECTION (Bottom) --- */
        .table-panel {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden; /* For border radius */
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        /* Styled Table like Image */
        .table-responsive {
            width: 100%;
            overflow-x: auto; /* Scroll on mobile */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            min-width: 600px; /* Force scroll on small screens */
        }

        thead {
            background: rgba(255,255,255,0.05);
            border-bottom: 2px solid var(--primary);
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #eee;
        }

        tr:hover td {
            background: rgba(221, 72, 20, 0.1); /* Red tint on hover */
            cursor: pointer;
        }

        .staff-name-cell {
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background-color: #555;
            display: inline-block;
        }

        /* --- DASHBOARD / CLOCK IN VIEW (Modal Style) --- */
        .dashboard-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .dashboard-card {
            background: #1a1a1a;
            width: 90%;
            max-width: 450px;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid var(--primary);
            text-align: center;
            position: relative;
            box-shadow: 0 0 50px rgba(221, 72, 20, 0.3);
        }

        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: none; border: none;
            color: #888; font-size: 1.2rem;
            cursor: pointer;
        }

        .time-display {
            font-size: 3rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            color: white;
            margin: 10px 0;
        }

        .btn-action {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
        }
        .btn-in { background: var(--success); color: white; }
        .btn-out { background: var(--danger); color: white; }
        .btn-in:disabled, .btn-out:disabled { opacity: 0.3; cursor: not-allowed; }

        /* --- ADMIN FORM --- */
        .admin-form-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        label { color: #aaa; font-size: 0.85rem; display: block; margin-bottom: 5px; }
        input[type="time"] {
            width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 6px;
        }

        /* Utils */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: #333; }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <img src="logoGTR.png" alt="GTR Logo"> 
            <span class="brand-text">SHIFT SYSTEM</span>
        </div>
        <button class="mode-btn" onclick="switchMode()">
            <i class="fas fa-user-cog"></i> Admin Panel
        </button>
    </header>

    <div id="staffSection" class="container">
        
        <div class="search-panel">
            <span class="search-label"><i class="fas fa-search"></i> Find Staff Schedule</span>
            <div class="search-bar-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="searchStaffInput" placeholder="Enter Staff Name or ID..." onkeyup="filterStaffTable()">
            </div>
        </div>

        <nav style="margin-bottom: 10px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">
            <span>Tip: Click on a staff row to open Clock In panel.</span>

        <div class="table-panel">
            <div class="panel-header">
                <h3 class="panel-title">Staff Roster List</h3>
                <span style="font-size: 0.8rem; opacity: 0.8;">Tap Name to Clock In</span>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Staff Name / ID</th>
                            <th>Shift Start</th>
                            <th>Shift End</th>
                            <th class="text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="publicStaffTableBody">
                        </tbody>
                </table>
            </div>
            <div id="emptyMsg" style="padding: 20px; text-align: center; color: #777; display: none;">No staff found.</div>
        </div>
    </div>

    <div id="clockInModal" class="dashboard-overlay hidden">
        <div class="dashboard-card">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            
            <h3 id="modalStaffName" style="color: var(--primary); margin-top: 0;">-</h3>
            <p style="color: #aaa; font-size: 0.9rem;">Shift Schedule</p>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <div style="background: #333; padding: 10px 20px; border-radius: 8px;">
                    <small style="color:#888; display:block;">START</small>
                    <strong id="modalStart" style="font-size: 1.2rem;">-</strong>
                </div>
                <div style="background: #333; padding: 10px 20px; border-radius: 8px;">
                    <small style="color:#888; display:block;">END</small>
                    <strong id="modalEnd" style="font-size: 1.2rem;">-</strong>
                </div>
            </div>

            <div class="time-display" id="liveClock">00:00:00</div>
            <p id="liveDate" style="color: var(--primary); margin-top: -10px; font-weight: 600;">-</p>

            <div id="statusBadge" class="badge" style="margin: 10px auto; display: inline-block;">Ready</div>

            <button id="btnIn" class="btn-action btn-in" onclick="doClockIn()">CLOCK IN</button>
            <button id="btnOut" class="btn-action btn-out" onclick="doClockOut()" disabled>CLOCK OUT</button>
        </div>
    </div>

    <div id="adminSection" class="container hidden">
        <div class="panel-header" style="border-radius: 12px 12px 0 0; background: #333;">
            <h3 class="panel-title">Admin Management</h3>
        </div>
        
        <div class="admin-form-container">
            <h4 style="margin: 0 0 15px 0; color: var(--primary);">Add / Edit Staff Shift</h4>
            <div class="search-bar-wrapper" style="margin-bottom: 10px;">
                <input type="text" id="adminName" placeholder="Full Staff Name">
            </div>
            <div class="grid-row">
                <div>
                    <label>Shift Start</label>
                    <input type="time" id="adminStart">
                </div>
                <div>
                    <label>Shift End</label>
                    <input type="time" id="adminEnd">
                </div>
            </div>
            <button class="btn-action btn-in" style="background: var(--primary); margin-top: 15px;" onclick="saveRoster()">Save Schedule</button>
        </div>

        <div class="table-panel">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Shift</th>
                            <th class="text-right">Manage</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <button onclick="switchMode()" style="margin-top: 20px; background: none; border: 1px solid #555; color: #888; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer;">
            Back to Staff View
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUBoGLEI2rbOCQ2tLkCUZ-OIm35QRxiGs",
            authDomain: "gtr-pitstop.firebaseapp.com",
            projectId: "gtr-pitstop",
            storageBucket: "gtr-pitstop.firebasestorage.app",
            messagingSenderId: "661099399124",
            appId: "1:661099399124:web:b6590f033eaa3a0c3e3841",
            measurementId: "G-R210LCD60D"
        };

        let db;
        let allStaffList = [];

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            loadPublicStaffList(); 
        } catch (e) { console.error("Firebase Error", e); }

        // --- GLOBAL STATE ---
        let currentUserSchedule = null;

        // --- NAVIGATION ---
        window.switchMode = function() {
            const staffSec = document.getElementById('staffSection');
            const adminSec = document.getElementById('adminSection');
            
            if (staffSec.classList.contains('hidden')) {
                staffSec.classList.remove('hidden');
                adminSec.classList.add('hidden');
                loadPublicStaffList();
            } else {
                const pass = prompt("Admin Password:");
                if (pass === "12345") {
                    staffSec.classList.add('hidden');
                    adminSec.classList.remove('hidden');
                    loadAdminTable();
                }
            }
        }

        window.closeModal = function() {
            document.getElementById('clockInModal').classList.add('hidden');
            currentUserSchedule = null;
        }

        // --- CLOCK & DATE ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('liveClock').innerText = timeStr;
            document.getElementById('liveDate').innerText = now.toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            if (currentUserSchedule && !document.getElementById('btnOut').disabled) {
                if (timeStr.substring(0,5) >= currentUserSchedule.shiftEnd) {
                    doClockOut(true);
                }
            }
        }
        setInterval(updateClock, 1000);

        // --- STAFF TABLE FUNCTIONS ---
        async function loadPublicStaffList() {
            if (!db) return;
            const tbody = document.getElementById('publicStaffTableBody');
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>Loading Roster...</td></tr>";
            
            try {
                const querySnapshot = await getDocs(collection(db, "schedules"));
                allStaffList = [];
                querySnapshot.forEach((doc) => allStaffList.push(doc.data()));
                renderTable(allStaffList);
            } catch (e) {
                console.error(e);
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Error Loading Data</td></tr>";
            }
        }

        function renderTable(list) {
            const tbody = document.getElementById('publicStaffTableBody');
            const emptyMsg = document.getElementById('emptyMsg');
            tbody.innerHTML = "";

            if (list.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';

            list.forEach(staff => {
                const tr = document.createElement('tr');
                tr.onclick = () => openClockModal(staff);
                tr.innerHTML = `
                    <td>
                        <div class="staff-name-cell">
                            <span class="status-dot"></span>
                            ${staff.name}
                        </div>
                    </td>
                    <td>${staff.shiftStart}</td>
                    <td>${staff.shiftEnd}</td>
                    <td class="text-right">
                        <button style="background:none; border:1px solid #555; color:#ccc; border-radius:4px; cursor:pointer;">SELECT</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.filterStaffTable = function() {
            const query = document.getElementById('searchStaffInput').value.toLowerCase();
            const filtered = allStaffList.filter(staff => staff.name.toLowerCase().includes(query));
            renderTable(filtered);
        }

        function openClockModal(staff) {
            currentUserSchedule = staff;
            document.getElementById('clockInModal').classList.remove('hidden');
            
            document.getElementById('modalStaffName').innerText = staff.name;
            document.getElementById('modalStart').innerText = staff.shiftStart;
            document.getElementById('modalEnd').innerText = staff.shiftEnd;
            
            // Reset UI
            document.getElementById('btnIn').disabled = false;
            document.getElementById('btnIn').style.display = 'block';
            document.getElementById('btnOut').disabled = true;
            document.getElementById('statusBadge').innerText = "Ready to Clock In";
            document.getElementById('statusBadge').style.background = "#555";
        }

        // --- CLOCK IN LOGIC ---
        window.doClockIn = async function() {
            if(!currentUserSchedule) return;
            const btnIn = document.getElementById('btnIn');
            btnIn.disabled = true;
            btnIn.innerText = "Processing...";

            try {
                await addDoc(collection(db, "attendance"), {
                    name: currentUserSchedule.name,
                    type: "CLOCK_IN",
                    shiftStart: currentUserSchedule.shiftStart,
                    shiftEnd: currentUserSchedule.shiftEnd,
                    timestamp: serverTimestamp(),
                    localTime: new Date().toString()
                });

                btnIn.style.display = 'none';
                document.getElementById('btnOut').disabled = false;
                const badge = document.getElementById('statusBadge');
                badge.innerText = "CLOCKED IN";
                badge.style.background = "var(--success)";
            } catch (e) {
                alert("Error");
                btnIn.disabled = false;
            }
        }

        window.doClockOut = async function(isAuto = false) {
            if(!currentUserSchedule) return;
            const btnOut = document.getElementById('btnOut');
            btnOut.disabled = true;
            btnOut.innerText = isAuto ? "Auto Out..." : "Processing...";

            try {
                await addDoc(collection(db, "attendance"), {
                    name: currentUserSchedule.name,
                    type: "CLOCK_OUT",
                    method: isAuto ? "AUTO" : "MANUAL",
                    timestamp: serverTimestamp(),
                    localTime: new Date().toString()
                });
                
                const badge = document.getElementById('statusBadge');
                badge.innerText = "CLOCKED OUT";
                badge.style.background = "var(--danger)";
            } catch (e) { console.error(e); }
        }

        // --- ADMIN LOGIC ---
        window.saveRoster = async function() {
            const name = document.getElementById('adminName').value.trim();
            const start = document.getElementById('adminStart').value;
            const end = document.getElementById('adminEnd').value;
            if (!name || !start || !end) return alert("Fill all fields");

            await setDoc(doc(db, "schedules", name), { name, shiftStart: start, shiftEnd: end }, { merge: true });
            alert("Saved!");
            document.getElementById('adminName').value = "";
            loadAdminTable();
        }

        window.deleteStaff = async function(name) {
            if(confirm("Delete " + name + "?")) {
                await deleteDoc(doc(db, "schedules", name));
                loadAdminTable();
            }
        }

        async function loadAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            const querySnapshot = await getDocs(collection(db, "schedules"));
            tbody.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                tbody.innerHTML += `
                    <tr>
                        <td>${data.name}</td>
                        <td>${data.shiftStart} - ${data.shiftEnd}</td>
                        <td class="text-right">
                            <button onclick="deleteStaff('${data.name}')" style="color:red; background:none; border:none; cursor:pointer;">DELETE</button>
                        </td>
                    </tr>`;
            });
        }
        
        window.deleteStaff = window.deleteStaff;
    </script>
</body>
</html>
